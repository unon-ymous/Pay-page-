      const blob = await res.blob();
      triggerDownload(blob, 'upi-qr.png');
      showToast('QR downloaded');
      return;
    }
    // otherwise fetch remote image as blob
    const resp = await fetch(src, {mode:'cors'});
    if(!resp.ok) throw new Error('Network response not ok');
    const blob = await resp.blob();
    triggerDownload(blob, 'upi-qr.png');
    showToast('QR downloaded');
  }catch(err){
    console.warn('Download failed', err);
    // As last fallback, open image in new tab — but we try to avoid this
    window.open(qrImg.src, '_blank');
    showToast('Could not download directly — opened image to save manually');
  }
}
function triggerDownload(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

downloadBtn.addEventListener('click', downloadQr);

// Copy UPI
document.getElementById('copyUpi').addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(ADMIN.upi); showToast('UPI copied to clipboard'); }
  catch(e){ const t=document.createElement('textarea'); t.value=ADMIN.upi; document.body.appendChild(t); t.select(); document.execCommand('copy'); t.remove(); showToast('UPI copied'); }
});

// App openers (no amount passed — user fills in app)
const PACK = { gpay:'com.google.android.apps.nbu.paisa.user', phonepe:'com.phonepe.app', paytm:'net.one97.paytm' };
function openChain(pref){
  const query = new URLSearchParams({pa:ADMIN.upi,pn:ADMIN.payeeName,cu:'INR'}).toString();
  const generic = 'upi://pay?' + query;
  const ua = navigator.userAgent || '';
  const isAndroid = /Android/i.test(ua);
  const isIOS = /iPhone|iPad|iPod/i.test(ua);
  if(isAndroid){ let i=0; function next(){ if(i>=pref.length){ window.location.href = generic; return; } const key=pref[i++]; const pkg=PACK[key]; if(!pkg){ next(); return; } const intent = `intent://pay?${query}#Intent;scheme=upi;package=${pkg};end`; window.location.href = intent; setTimeout(next,1200);} next(); }
  else if(isIOS){ window.location.href = generic; } else { alert('Open on mobile to pay via UPI.'); }
}

document.getElementById('btnPaytm').addEventListener('click', ()=>openChain(['paytm','phonepe','gpay']));
