<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Pay Here ‚Äî UPI Payment</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --page-bg:#eef6fb;
      --panel:#ffffff;
      --muted:#6b7280;
      --accent:#0b61ff;
      --radius:12px;
      --shadow:0 10px 30px rgba(12,20,40,0.06);
      --light-gray:#f3f4f6;
      --copy-gray:#eef2f6;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;background:var(--page-bg);color:#0f1724}

    .page{max-width:760px;margin:18px auto;padding:0 12px}
    .card{background:linear-gradient(180deg,#f8fcff,#ffffff);border-radius:16px;padding:14px;box-shadow:var(--shadow);overflow:hidden;position:relative}

    .topbar{display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;background:linear-gradient(90deg,#e6f5ff,#dff2ff)}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#0b61ff,#33a1ff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:18px}
    .title{font-size:26px;font-style:italic;color:#08324a;font-weight:800;letter-spacing:0.3px}

    .qr-wrap{display:flex;flex-direction:column;align-items:center;gap:12px;padding:12px;position:relative}
    .qr-frame{width:320px;height:320px;border-radius:12px;border:1px dashed rgba(8,12,20,0.06);overflow:hidden;background:#fff;display:grid;place-items:center;position:relative}
    .qr-frame img{width:100%;height:100%;object-fit:cover;display:block}
    .controls{display:flex;gap:10px;align-items:center;width:92%}
    .download{flex:1;padding:12px;border-radius:18px;background:linear-gradient(90deg,#dff7e1,#c6f0c9);border:1px solid rgba(10,91,46,0.08);font-weight:700;cursor:pointer}

    .secret-area { position:absolute; width:40px; height:40px; opacity:0; z-index:60; cursor:pointer; -webkit-tap-highlight-color:transparent; outline:none; background:transparent; }

    .upi-box{margin-top:10px;display:flex;align-items:center;gap:8px;width:92%}
    .upi-pill{flex:1;display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-radius:10px;background:#fafcff;border:1px solid rgba(8,12,20,0.06);font-weight:700}
    .upi-text{font-size:15px;color:#0b1f2f}
    .copy-btn{padding:6px 10px;border-radius:8px;background:var(--copy-gray);color:#425066;border:0;cursor:pointer;font-weight:700}

    .apps{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .app-btn{padding:12px;border-radius:10px;border:0;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;filter:brightness(0.92)}
    .paytm{background:linear-gradient(90deg,#dbe9ff,#bfe0ff);color:#003366}
    .gpay{background:linear-gradient(90deg,#fffef6,#fff3e6);color:#111;border:1px solid rgba(0,0,0,0.06)}
    .phonepe{background:linear-gradient(90deg,#ecdfff,#e0d0ff);color:#3a0b66}
    .other{background:linear-gradient(90deg,#d0c8ff,#c0b8ff);color:#221f3a}

    .carousel-wrap{margin-top:12px}
    .carousel-header{padding:8px;border-radius:8px;background:linear-gradient(180deg,#f5f7fa,#ffffff);border:1px solid rgba(8,12,20,0.04);color:#475569;font-weight:700;font-size:14px}
    .carousel{margin-top:8px;overflow:hidden;border-radius:8px;height:340px}
    .slides{display:flex;transition:transform 0.6s ease;gap:0}
    .slide{min-width:100%;flex-shrink:0;padding:0;height:100%;display:flex;justify-content:center;align-items:center}
    .slide img{width:100%;height:340px;object-fit:contain;border-radius:8px}

    .instructions-box{margin-top:12px;padding:10px;border-radius:10px;background:linear-gradient(180deg,#f8fbff,#ffffff);border:1px solid rgba(8,12,20,0.04);box-shadow:0 6px 18px rgba(11,97,255,0.03)}
    .how-title{font-weight:800;color:#111;margin-bottom:8px}
    .how-list{display:flex;flex-direction:column;gap:6px}
    .how-item{background:transparent;padding:6px;color:#475569;font-size:13px}

    .contact-row{display:flex;flex-direction:column;align-items:center;gap:8px;margin-top:14px;justify-content:center}
    .contact-btn{padding:12px 18px;border-radius:8px;background:#f3f4f6;color:#111;border:0;font-weight:800;cursor:pointer;height:40px}
    .contact-small{font-size:13px;color:var(--muted);text-align:center;margin-top:6px}

    @media (max-width:480px){ .qr-frame{width:260px;height:260px} .title{font-size:22px} }

    .modal-backdrop{position:fixed;inset:0;background:rgba(4,8,20,0.35);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal{width:95%;max-width:720px;background:#fff;border-radius:12px;padding:22px;box-shadow:0 20px 60px rgba(2,8,23,0.35)}
    .modal h3{margin:0 0 12px;font-size:20px}
    .modal label{display:block;margin:10px 0 6px;font-size:15px;color:#334155}
    .modal input[type=text], .modal input[type=file]{width:100%;padding:14px;border-radius:10px;border:1px solid #e6eef6;font-size:16px}
    .modal .row{display:flex;gap:12px;margin-top:18px}
    .modal button{padding:12px 14px;border-radius:10px;border:0;cursor:pointer;font-size:15px}
    .modal .save{background:linear-gradient(90deg,#0b61ff,#33a1ff);color:#fff;font-weight:800}
    .modal .cancel{background:#f3f4f6;color:#111}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:rgba(11,97,255,0.95);color:#fff;padding:8px 12px;border-radius:8px;z-index:10000}
  </style>
</head>
<body>
  <div class="page">
    <div class="card" id="cardRoot">
      <div class="topbar">
        <div class="logo" id="logo">Pay</div>
        <div class="title">Pay Here</div>
      </div>

      <div class="qr-wrap">
        <div class="qr-frame" id="qrframe"><img id="qrimg" src="" alt="QR image" /></div>
        <div class="controls"><button id="downloadBtn" class="download">Download QR Code</button></div>
      </div>

      <div class="upi-box">
        <div class="upi-pill">
          <div class="upi-text" id="upiField">merchant@upi</div>
          <button id="copyUpi" class="copy-btn" type="button">Copy</button>
        </div>
      </div>

      <div class="apps">
        <button id="btnPaytm" class="app-btn paytm" type="button">PAYTM</button>
        <button id="btnGpay" class="app-btn gpay" type="button">G PAY</button>
        <button id="btnPhonePe" class="app-btn phonepe" type="button">Phone ‡§™‡•á</button>
        <button id="btnOther" class="app-btn other" type="button">Other UPI Apps</button>
      </div>

      <div class="carousel-wrap">
        <div class="carousel-header">üì≤  How to send payment Screenshot</div>
        <div class="carousel"><div class="slides" id="slides"></div></div>
      </div>

      <div class="instructions-box">
        <div class="how-title">Instruction ‚ùó</div>
        <div class="how-list" id="howList"></div>
      </div>

      <div style="display:flex;align-items:center;justify-content:center;margin-top:14px;position:relative;">
        <div style="width:56px;height:40px;display:inline-block;vertical-align:middle;position:relative;"></div>
        <div class="contact-row" style="text-align:center;">
          <button id="contactBtn" class="contact-btn" type="button">üí¨ Contact Admin</button>
          <div class="contact-small" id="contactSmall">Send Screenshot to Admin</div>
        </div>
      </div>

      <!-- hidden area will be positioned by JS -->
      <div class="secret-area" id="secretArea" title="secret"></div>

    </div>
  </div>

  <div class="modal-backdrop" id="adminModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="adminTitle">
      <h3 id="adminTitle">Admin: Update UPI & QR</h3>

      <label for="adminUpi">UPI ID (pa)</label>
      <input id="adminUpi" type="text" placeholder="example@bank" />

      <label for="adminName">Payee name (pn)</label>
      <input id="adminName" type="text" placeholder="Merchant Name" />

      <label for="adminQrFile">Upload QR image (select from gallery / file)</label>
      <input id="adminQrFile" type="file" accept="image/*" />

      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button class="cancel" id="cancelAdmin" type="button">Cancel</button>
        <button class="save" id="saveAdmin" type="button">Save</button>
      </div>
    </div>
  </div>

  <script>
    // Default configuration (kept as in your original)
    const ADMIN = {
      upi: 'paytm.s1tbcvt@pty',
      payeeName: 'Merchant Name',
      contactLink: 'https://wa.me/919999999999',
      contactText: 'Contact Admin',
      carousel: [
        'https://i.ibb.co/gFPbGzZH/20251118-155331.jpg',
        'https://i.ibb.co/TBTd5S3p/20251118-160648.jpg',
        'https://i.ibb.co/fVJnf9V7/20251118-153613.jpg'
      ],
      instructions: [
        'Open any UPI app or scan the QR with your UPI app.',
        'Confirm the UPI ID and payee name before approving.',
        'Enter the exact amount in your UPI app (do not rely on defaults).',
        'After payment, take a screenshot and send it to admin for confirmation.'
      ]
    };

    // DOM refs
    const upiField = document.getElementById('upiField');
    const qrImg = document.getElementById('qrimg');
    const downloadBtn = document.getElementById('downloadBtn');
    const slidesEl = document.getElementById('slides');
    const howList = document.getElementById('howList');
    const contactBtn = document.getElementById('contactBtn');

    // load saved config from localStorage
    function loadSavedConfig(){
      try {
        const raw = localStorage.getItem('upi_page_cfg');
        if (!raw) return null;
        return JSON.parse(raw);
      } catch(e) { return null; }
    }
    const saved = loadSavedConfig();
    if (saved && saved.upi) {
      ADMIN.upi = saved.upi;
      ADMIN.payeeName = saved.payeeName || ADMIN.payeeName;
      if (saved.qrDataUrl) ADMIN.qrDataUrl = saved.qrDataUrl;
    }

    upiField.textContent = ADMIN.upi;
    contactBtn.textContent = (ADMIN.contactText || 'Contact Admin') + '  üí¨';

    // robust image helpers
    const PLACEHOLDER_SVG = 'data:image/svg+xml;utf8,' + encodeURIComponent(
      '<svg xmlns="http://www.w3.org/2000/svg" width="600" height="340"><rect width="100%" height="100%" fill="#f3f4f6"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9ca3af" font-size="20">Image unavailable</text></svg>'
    );

    async function tryFetchAsBlob(url) {
      try {
        const r = await fetch(url, { mode: 'cors' });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const blob = await r.blob();
        return URL.createObjectURL(blob);
      } catch (err) {
        throw new Error('Fetch failed for ' + url + ' ‚Äî ' + err.message);
      }
    }

    function setImgWithDirectFallback(imgEl, url) {
      return new Promise(resolve => {
        let done = false;
        function finish(ok, reason) {
          if (done) return;
          done = true;
          imgEl.removeEventListener('load', onload);
          imgEl.removeEventListener('error', onerror);
          resolve({ ok, reason });
        }
        function onload(){ finish(true); }
        function onerror(){ finish(false, 'direct assignment failed'); }

        imgEl.addEventListener('load', onload);
        imgEl.addEventListener('error', onerror);
        imgEl.src = url;
        setTimeout(()=> finish(!!imgEl.complete && imgEl.naturalWidth>0, 'timeout'), 2500);
      });
    }

    async function robustLoadImage(imgEl, url) {
      if (!url) { imgEl.src = PLACEHOLDER_SVG; console.warn('No URL provided'); return; }
      if (url.startsWith('data:')) {
        const res = await setImgWithDirectFallback(imgEl, url);
        if (res.ok) return;
        console.warn('Data URL failed to load:', res.reason);
        imgEl.src = PLACEHOLDER_SVG;
        return;
      }
      if (location.protocol === 'https:' && url.startsWith('http:')) {
        if (url.startsWith('http://')) {
          url = 'https://' + url.slice(7);
        }
      }
      try {
        const blobUrl = await tryFetchAsBlob(url);
        const res = await setImgWithDirectFallback(imgEl, blobUrl);
        if (res.ok) {
          setTimeout(()=> URL.revokeObjectURL(blobUrl), 30000);
          return;
        } else {
          console.warn('Blob assignment failed, trying direct URL...', url, res.reason);
        }
      } catch (err) {
        console.warn(err.message);
      }
      const directResult = await setImgWithDirectFallback(imgEl, url);
      if (directResult.ok) return;
      console.warn('All attempts to load image failed:', url, directResult.reason || 'unknown');
      imgEl.src = PLACEHOLDER_SVG;
    }

    async function populateCarouselRobust(urls, slidesEl) {
      slidesEl.innerHTML = '';
      for (const url of urls) {
        const s = document.createElement('div'); s.className = 'slide';
        const img = document.createElement('img'); img.alt = 'step';
        s.appendChild(img);
        slidesEl.appendChild(s);
        try {
          await robustLoadImage(img, url);
          await new Promise(r=>setTimeout(r, 120));
        } catch(e) {
          console.warn('carousel image failed', url, e);
        }
      }
    }

    async function setQrRobust(imgEl, cfg) {
      const sources = [];
      if (cfg.qrDataUrl) sources.push(cfg.qrDataUrl);
      if (cfg.qrImageUrl) sources.push(cfg.qrImageUrl);
      if (cfg.upi) {
        const uri = 'upi://pay?pa=' + encodeURIComponent(cfg.upi) + '&pn=' + encodeURIComponent(cfg.payeeName || '') + '&cu=INR';
        sources.push('https://chart.googleapis.com/chart?cht=qr&chs=1000x1000&chl=' + encodeURIComponent(uri));
      }
      for (const src of sources) {
        try {
          await robustLoadImage(imgEl, src);
          if (imgEl.naturalWidth && imgEl.naturalWidth > 10) return;
        } catch(err) {
          console.warn('QR attempt failed for', src, err);
        }
      }
      imgEl.src = PLACEHOLDER_SVG;
    }

    (async function initImages(){
      try { await populateCarouselRobust(ADMIN.carousel, slidesEl); } catch(e){ console.warn('carousel init error', e); }
      try { await setQrRobust(qrImg, { qrDataUrl: ADMIN.qrDataUrl, qrImageUrl: ADMIN.qrImageUrl, upi: ADMIN.upi, payeeName: ADMIN.payeeName }); } catch(e){ console.warn('qr init error', e); }
    })();

    // download QR
    async function downloadQr(){
      try {
        const src = qrImg.src;
        const resp = await fetch(src, { mode: 'cors' });
        if (!resp.ok) throw new Error('Network response not ok');
        const blob = await resp.blob();
        triggerDownload(blob, 'upi-qr-' + Date.now() + '.png');
        showToast('QR downloaded to device');
      } catch(err) {
        console.warn('Download failed, fallback to open', err);
        window.open(qrImg.src, '_blank');
        showToast('Could not download directly ‚Äî opened image to save manually');
      }
    }
    function triggerDownload(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }
    downloadBtn.addEventListener('click', downloadQr);

    // copy UPI
    document.getElementById('copyUpi').addEventListener('click', async ()=>{
      try {
        await navigator.clipboard.writeText(ADMIN.upi);
        showToast('UPI copied to clipboard');
      } catch(e) {
        const t = document.createElement('textarea'); t.value = ADMIN.upi; document.body.appendChild(t); t.select();
        document.execCommand('copy'); t.remove(); showToast('UPI copied to clipboard');
      }
    });

    // UPI app intents
    const PACK = { gpay:'com.google.android.apps.nbu.paisa.user', phonepe:'com.phonepe.app', paytm:'net.one97.paytm' };
    function openChain(pref){
      const query = 'pa=' + encodeURIComponent(ADMIN.upi) + '&pn=' + encodeURIComponent(ADMIN.payeeName || '') + '&cu=INR';
      const generic = 'upi://pay?' + query;
      const ua = navigator.userAgent || '';
      const isAndroid = /Android/i.test(ua);
      const isIOS = /iPhone|iPad|iPod/i.test(ua);
      if (isAndroid){
        let i = 0;
        function next(){
          if (i >= pref.length){ window.location.href = generic; return; }
          const key = pref[i++]; const pkg = PACK[key];
          if (!pkg){ next(); return; }
          const intent = 'intent://pay?' + query + '#Intent;scheme=upi;package=' + pkg + ';end';
          window.location.href = intent;
          setTimeout(next, 1200);
        }
        next();
      } else if (isIOS) {
        window.location.href = generic;
      } else {
        alert('Open this page on a mobile device to complete the UPI payment.');
      }
    }
    document.getElementById('btnPaytm').addEventListener('click', ()=>openChain(['paytm','phonepe','gpay']));
    document.getElementById('btnGpay').addEventListener('click', ()=>openChain(['gpay','phonepe','paytm']));
    document.getElementById('btnPhonePe').addEventListener('click', ()=>openChain(['phonepe','paytm','gpay']));
    document.getElementById('btnOther').addEventListener('click', ()=>{ window.location.href = 'upi://pay?pa=' + encodeURIComponent(ADMIN.upi) + '&pn=' + encodeURIComponent(ADMIN.payeeName) + '&cu=INR'; });

    // contact
    contactBtn.addEventListener('click', ()=> window.open(ADMIN.contactLink, '_blank'));

    // toast
    function showToast(msg){
      const t = document.createElement('div');
      t.textContent = msg;
      t.className = 'toast';
      document.body.appendChild(t);
      setTimeout(()=> t.style.opacity='0.01', 1500);
      setTimeout(()=> t.remove(), 2000);
    }

    // QR img error fallback
    qrImg.addEventListener('error', ()=>{ qrImg.src = PLACEHOLDER_SVG; });

    // ADMIN trigger + morse password
    const MORSE_MAP = {'A':'.-','B':'-...','C':'-.-.','D':'-..','E':'.','F':'..-.','G':'--.','H':'....','I':'..','J':'.---','K':'-.-','L':'.-..','M':'--','N':'-.','O':'---','P':'.--.','Q':'--.-','R':'.-.','S':'...','T':'-','U':'..-','V':'...-','W':'.--','X':'-..-','Y':'-.--','Z':'--..','0':'-----','1':'.----','2':'..---','3':'...--','4':'....-','5':'.....','6':'-....','7':'--...','8':'---..','9':'----.'};
    function textToMorse(text){ return text.toUpperCase().split('').map(ch => MORSE_MAP[ch] || ch).join(' '); }
    function normalizeMorse(s){ return (''+s).trim().replace(/\s+/g,' '); }
    // MORSE for "1C2B3A"
    const MORSE_SECRET = '.---- -.-. ..--- -... ...-- .-';

    // position the small hidden area left of contact button
    (function positionSecretArea(){
      const card = document.getElementById('cardRoot');
      const secret = document.getElementById('secretArea');
      const contact = document.getElementById('contactBtn');
      if (!card || !secret || !contact) return;
      setTimeout(()=> {
        const cardRect = card.getBoundingClientRect();
        const contactRect = contact.getBoundingClientRect();
        const left = Math.max(8, contactRect.left - cardRect.left - 56);
        const bottom = (cardRect.bottom - contactRect.bottom) + 12;
        secret.style.left = left + 'px';
        secret.style.bottom = bottom + 'px';
        secret.style.display = 'block';
      }, 60);
      window.addEventListener('resize', ()=> setTimeout(positionSecretArea, 60));
    })();

    // detect 7 taps
    const secretArea = document.getElementById('secretArea');
    let tapCount = 0, tapTimer = null;
    const REQUIRED_TAPS = 7;
    secretArea.addEventListener('click', ()=>{
      tapCount++;
      clearTimeout(tapTimer);
      tapTimer = setTimeout(()=> tapCount = 0, 1200);
      if (tapCount >= REQUIRED_TAPS){
        tapCount = 0;
        promptAdminPassword();
      }
    });
    document.getElementById('logo').addEventListener('dblclick', promptAdminPassword);

    let failedAttempts = 0;
    function promptAdminPassword(){
      if (failedAttempts >= 6){
        showToast('Too many failed attempts ‚Äî wait 8s');
        setTimeout(()=> failedAttempts = 0, 8000);
        return;
      }
      const entered = prompt('Enter admin password:');
      if (entered === null) return;
      const enteredMorse = normalizeMorse(textToMorse(entered));
      if (enteredMorse === normalizeMorse(MORSE_SECRET)){
        openAdminModal();
      } else {
        failedAttempts++;
        alert('Wrong password');
      }
    }

    // admin modal logic
    const adminModal = document.getElementById('adminModal');
    const adminUpi = document.getElementById('adminUpi');
    const adminName = document.getElementById('adminName');
    const adminQrFile = document.getElementById('adminQrFile');
    const saveAdminBtn = document.getElementById('saveAdmin');
    const cancelAdminBtn = document.getElementById('cancelAdmin');

    function openAdminModal(){
      adminModal.style.display = 'flex';
      adminModal.setAttribute('aria-hidden','false');
      adminUpi.value = ADMIN.upi || '';
      adminName.value = ADMIN.payeeName || '';
      adminQrFile.value = '';
    }
    cancelAdminBtn.addEventListener('click', ()=> { adminModal.style.display = 'none'; adminModal.setAttribute('aria-hidden','true'); });

    // robust file handling helpers (no preview)
    function readFileAsDataURL(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = ()=> resolve(r.result);
        r.onerror = ()=> reject(new Error('Could not read file'));
        r.readAsDataURL(file);
      });
    }
    function loadImage(dataUrl){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = ()=> resolve(img);
        img.onerror = ()=> reject(new Error('Image decode failed'));
        img.src = dataUrl;
      });
    }
    function drawSquareCanvas(img, size){
      const canvas = document.createElement('canvas');
      canvas.width = size; canvas.height = size;
      const ctx = canvas.getContext('2d');
      const w = img.naturalWidth, h = img.naturalHeight;
      const side = Math.min(w,h);
      const sx = Math.floor((w - side)/2), sy = Math.floor((h - side)/2);
      ctx.drawImage(img, sx, sy, side, side, 0, 0, size, size);
      return canvas;
    }
    function estimateDataUrlSize(dataUrl){
      const i = dataUrl.indexOf('base64,');
      if (i === -1) return dataUrl.length;
      const b64 = dataUrl.slice(i + 7);
      return Math.ceil((b64.length * 3) / 4);
    }
    function compressCanvasToDataUrl(canvas, maxBytes){
      let dataUrl = canvas.toDataURL('image/png');
      if (estimateDataUrlSize(dataUrl) <= maxBytes) return dataUrl;
      const qualities = [0.92,0.8,0.7,0.6,0.5,0.4];
      for (const q of qualities){
        dataUrl = canvas.toDataURL('image/jpeg', q);
        if (estimateDataUrlSize(dataUrl) <= maxBytes) return dataUrl;
      }
      return dataUrl;
    }

    // save handler
    saveAdminBtn.addEventListener('click', async () => {
      const newUpi = adminUpi.value.trim();
      const newName = adminName.value.trim();
      if (!newUpi){ alert('UPI required'); return; }

      let finalDataUrl = ADMIN.qrDataUrl || '';

      if (adminQrFile.files && adminQrFile.files[0]){
        const file = adminQrFile.files[0];
        const unsupported = /heic|heif/i;
        if (unsupported.test(file.type) || /\.heic$/i.test(file.name) || /\.heif$/i.test(file.name)){
          alert('HEIC/HEIF images are not supported by many browsers. Please convert to JPG/PNG or take a screenshot of the QR and upload that.');
          return;
        }
        if (!/^image\/(png|jpe?g|webp|gif|bmp|svg\+xml)$/.test(file.type)){
          if (!confirm('Selected file may be an uncommon image type ‚Äî try anyway?')) return;
        }
        try {
          const raw = await readFileAsDataURL(file);
          const img = await loadImage(raw);
          const canvas = drawSquareCanvas(img, 1000);
          const MAX_BYTES = 2.5 * 1024 * 1024;
          const compressed = compressCanvasToDataUrl(canvas, MAX_BYTES);
          const bytes = estimateDataUrlSize(compressed);
          if (bytes > 3.5 * 1024 * 1024){
            if (!confirm('Processed image is large and may not save in some browsers. Continue?')) return;
          }
          finalDataUrl = compressed;
        } catch(err){
          console.error('Image processing failed', err);
          alert('Could not process this image. Try a JPG/PNG or a smaller file.');
          return;
        }
      }

      ADMIN.upi = newUpi;
      ADMIN.payeeName = newName || ADMIN.payeeName;
      ADMIN.qrDataUrl = finalDataUrl;
      ADMIN.updatedAt = new Date().toISOString();

      try {
        localStorage.setItem('upi_page_cfg', JSON.stringify({
          upi: ADMIN.upi,
          payeeName: ADMIN.payeeName,
          qrDataUrl: ADMIN.qrDataUrl,
          updatedAt: ADMIN.updatedAt
        }));
      } catch(e){
        alert('Could not save settings ‚Äî storage may be full or blocked.');
        return;
      }

      upiField.textContent = ADMIN.upi;
      try { await robustLoadImage(qrImg, ADMIN.qrDataUrl || ('https://chart.googleapis.com/chart?cht=qr&chs=1000x1000&chl=' + encodeURIComponent('upi://pay?pa=' + ADMIN.upi + '&pn=' + ADMIN.payeeName + '&cu=INR'))); } catch(e){ qrImg.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="600" height="600"><rect width="100%" height="100%" fill="#f3f4f6"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9ca3af" font-size="20">QR Unavailable</text></svg>'); }
      adminModal.style.display = 'none';
      showToast('Admin changes saved (local)');
    });

  </script>
</body>
</html>
