<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Pay Here ‚Äî UPI Payment</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      :root{
        --page-bg:#eef6fb;
        --panel:#ffffff;
        --muted:#6b7280;
        --accent:#0b61ff;
        --radius:12px;
        --shadow:0 10px 30px rgba(12,20,40,0.06);
        --light-gray:#f3f4f6;
        --copy-gray:#eef2f6;
      }
      html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;background:var(--page-bg);color:#0f1724}

      /* container */
      .page{max-width:760px;margin:18px auto;padding:0 12px}
      .card{background:linear-gradient(180deg,#f8fcff,#ffffff);border-radius:16px;padding:14px;box-shadow:var(--shadow);overflow:hidden;position:relative}

      /* topbar */
      .topbar{display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;background:linear-gradient(90deg,#e6f5ff,#dff2ff)}
      .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#0b61ff,#33a1ff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:18px}
      .title{font-size:26px;font-style:italic;color:#08324a;font-weight:800;letter-spacing:0.3px}

      /* QR area */
      .qr-wrap{display:flex;flex-direction:column;align-items:center;gap:12px;padding:12px;position:relative}
      .qr-frame{width:320px;height:320px;border-radius:12px;border:1px dashed rgba(8,12,20,0.06);overflow:hidden;background:#fff;display:grid;place-items:center;position:relative}
      .qr-frame img{width:100%;height:100%;object-fit:cover;display:block}
      .controls{display:flex;gap:10px;align-items:center;width:92%}
      .download{flex:1;padding:12px;border-radius:18px;background:linear-gradient(90deg,#dff7e1,#c6f0c9);border:1px solid rgba(10,91,46,0.08);font-weight:700;cursor:pointer}

      /* invisible admin tap area (will be placed near contact button) */
      .secret-area {
        position: absolute;
        width: 40px;
        height: 40px;
        bottom: 18px; /* will be positioned relative to .card with left offset */
        left: 18px;   /* default, will be adjusted inside .card */
        opacity: 0;
        z-index: 60;
        cursor: pointer;
        /* ensure no visual change on active/focus */
        outline: none;
        -webkit-tap-highlight-color: transparent;
      }
      .secret-area:active, .secret-area:focus { background: transparent; }

      /* UPI single thin box with copy inside */
      .upi-box{margin-top:10px;display:flex;align-items:center;gap:8px;width:92%}
      .upi-pill{flex:1;display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-radius:10px;background:#fafcff;border:1px solid rgba(8,12,20,0.06);font-weight:700}
      .upi-text{font-size:15px;color:#0b1f2f}
      .copy-btn{padding:6px 10px;border-radius:8px;background:var(--copy-gray);color:#425066;border:0;cursor:pointer;font-weight:700}

      /* apps */
      .apps{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
      .app-btn{padding:12px;border-radius:10px;border:0;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center}
      .paytm{background:linear-gradient(90deg,#e6f0ff,#cfe6ff);color:#003366}
      .gpay{background:linear-gradient(90deg,#fff,#fff7ed);color:#111;border:1px solid rgba(0,0,0,0.06)}
      .phonepe{background:linear-gradient(90deg,#f3e9ff,#efe2ff);color:#3a0b66}
      .other{background:linear-gradient(90deg,#dcd6ff,#cfc6ff);color:#221f3a} /* darker */

      /* carousel + static header */
      .carousel-wrap{margin-top:12px}

      .carousel-header{
        padding:8px;
        border-radius:8px;
        background:linear-gradient(180deg,#f5f7fa,#ffffff);
        border:1px solid rgba(8,12,20,0.04);
        color:#475569;
        font-weight:700;
        font-size:14px;
      }

      .carousel{
        margin-top:8px;
        overflow:hidden;
        border-radius:8px;
        height:340px;
      }

      .slides{
        display:flex;
        transition:transform 0.6s ease;
        gap:0;
      }

      .slide{
        min-width:100%;
        flex-shrink:0;
        padding:0;
        height:100%;
        display:flex;
        justify-content:center;
        align-items:center;
      }

      .slide img{
        width:100%;
        height:340px;
        object-fit:contain;
        border-radius:8px;
      }

      /* instructions in light shiny box (smaller text) */
      .instructions-box{margin-top:12px;padding:10px;border-radius:10px;background:linear-gradient(180deg,#f8fbff,#ffffff);border:1px solid rgba(8,12,20,0.04);box-shadow:0 6px 18px rgba(11,97,255,0.03)}
      .how-title{font-weight:800;color:#111;margin-bottom:8px}
      .how-list{display:flex;flex-direction:column;gap:6px}
      .how-item{background:transparent;padding:6px;color:#475569;font-size:13px}

      /* contact */
      .contact-row{display:flex;flex-direction:row;align-items:center;gap:8px;margin-top:14px;justify-content:center}
      .contact-btn{padding:12px 18px;border-radius:8px;background:#f3f4f6;color:#111;border:0;font-weight:800;cursor:pointer;height:40px}
      .contact-small{font-size:13px;color:var(--muted);text-align:center}

      @media (max-width:480px){
        .qr-frame{width:260px;height:260px}
        .title{font-size:22px}
      }

      /* admin modal - larger and inputs bigger for easy tapping */
      .modal-backdrop{position:fixed;inset:0;background:rgba(4,8,20,0.35);display:none;align-items:center;justify-content:center;z-index:9999}
      .modal{width:95%;max-width:700px;background:#fff;border-radius:12px;padding:20px;box-shadow:0 20px 60px rgba(2,8,23,0.35)}
      .modal h3{margin:0 0 12px;font-size:20px}
      .modal label{display:block;margin:10px 0 6px;font-size:15px;color:#334155}
      .modal input[type=text], .modal input[type=file]{width:100%;padding:14px;border-radius:10px;border:1px solid #e6eef6;font-size:16px}
      .modal .row{display:flex;gap:12px;margin-top:16px}
      .modal button{padding:12px 14px;border-radius:10px;border:0;cursor:pointer;font-size:15px}
      .modal .save{background:linear-gradient(90deg,#0b61ff,#33a1ff);color:#fff;font-weight:800}
      .modal .cancel{background:#f3f4f6;color:#111}
      /* ensure toast visible */
      .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:rgba(11,97,255,0.95);color:#fff;padding:8px 12px;border-radius:8px;z-index:10000}
    </style>
  </head>

  <body>
    <div class="page">
      <div class="card" id="cardRoot">
        <!-- top bar in the same card -->
        <div class="topbar">
          <div class="logo" id="logo">Pay</div>
          <div class="title">Pay Here</div>
        </div>

        <!-- QR area -->
        <div class="qr-wrap">
          <div class="qr-frame" id="qrframe"><img id="qrimg" src="" alt="QR image"></div>
          <div class="controls">
            <button id="downloadBtn" class="download">Download QR Code</button>
          </div>
        </div>

        <!-- UPI thin pill with copy -->
        <div class="upi-box">
          <div class="upi-pill">
            <div class="upi-text" id="upiField">merchant@upi</div>
            <button id="copyUpi" class="copy-btn">Copy</button>
          </div>
        </div>

        <!-- App buttons -->
        <div class="apps">
          <button id="btnPaytm" class="app-btn paytm">PAYTM</button>
          <button id="btnGpay" class="app-btn gpay">G PAY</button>
          <button id="btnPhonePe" class="app-btn phonepe">Phone ‡§™‡•á</button>
          <button id="btnOther" class="app-btn other">Other UPI Apps</button>
        </div>

        <!-- carousel header (static) and carousel (images move) -->
        <div class="carousel-wrap">
          <div class="carousel-header">üì≤  How to send payment Screenshot</div>
          <div class="carousel"><div class="slides" id="slides"></div></div>
        </div>

        <!-- instructions -->
        <div class="instructions-box">
          <div class="how-title">Instruction ‚ùó</div>
          <div class="how-list" id="howList"></div>
        </div>

        <!-- contact and the small hidden secret area will be placed near here -->
        <div style="display:flex;align-items:center;justify-content:center;margin-top:14px;position:relative;">
          <!-- small spacer for left of contact where secret-area will sit -->
          <div style="width:56px;height:40px;display:inline-block;vertical-align:middle;position:relative;">
            <!-- secret area is positioned absolutely within card; left offset will be computed by JS to place it left of the contact button -->
            <!-- kept empty here -->
          </div>
          <div class="contact-row">
            <button id="contactBtn" class="contact-btn">üí¨ Contact Admin</button>
            <div class="contact-small" id="contactSmall">Send Screenshot to Admin</div>
          </div>
        </div>

        <!-- hidden secret target placed absolutely relative to .card via JS -->
        <div class="secret-area" id="secretArea" title="secret"></div>

      </div> <!-- .card -->
    </div> <!-- .page -->

    <!-- ADMIN MODAL (opens on correct password) -->
    <div class="modal-backdrop" id="adminModal">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="adminTitle">
        <h3 id="adminTitle">Admin: Update UPI & QR</h3>

        <label>UPI ID (pa)</label>
        <input id="adminUpi" type="text" placeholder="example@bank" />

        <label>Payee name (pn)</label>
        <input id="adminName" type="text" placeholder="Merchant Name" />

        <label>Upload QR image (select from gallery / file)</label>
        <input id="adminQrFile" type="file" accept="image/*" />

        <div class="row" style="justify-content:flex-end;margin-top:12px">
          <button class="cancel" id="cancelAdmin">Cancel</button>
          <button class="save" id="saveAdmin">Save</button>
        </div>
      </div>
    </div>

    <script>
      /* ========== ORIGINAL HOME PAGE CONFIG (kept intact) ========== */
      const ADMIN = {
        upi: 'paytm.s1tbcvt@pty',
        payeeName: 'Merchant Name',
        contactLink: 'https://wa.me/919999999999',
        contactText: 'Contact Admin',
        carousel: [
          'https://i.ibb.co/gFPbGzZH/20251118-155331.jpg',
          'https://i.ibb.co/TBTd5S3p/20251118-160648.jpg',
          'https://i.ibb.co/fVJnf9V7/20251118-153613.jpg'
        ],
        instructions: [
          'Open any UPI app or scan the QR with your UPI app.',
          'Confirm the UPI ID and payee name before approving.',
          'Enter the exact amount in your UPI app (do not rely on defaults).',
          'After payment, take a screenshot and send it to admin for confirmation.'
        ]
      };

      /* ---------- references ---------- */
      const upiField = document.getElementById('upiField');
      const qrImg = document.getElementById('qrimg');
      const downloadBtn = document.getElementById('downloadBtn');
      const slidesEl = document.getElementById('slides');
      const howList = document.getElementById('howList');
      const contactBtn = document.getElementById('contactBtn');

      /* ---------- load saved config from localStorage (if any) ---------- */
      function loadSavedConfig(){
        try{
          const raw = localStorage.getItem('upi_page_cfg');
          if(!raw) return null;
          return JSON.parse(raw);
        }catch(e){ return null; }
      }
      const saved = loadSavedConfig();
      if(saved && saved.upi){
        ADMIN.upi = saved.upi;
        ADMIN.payeeName = saved.payeeName || ADMIN.payeeName;
        if(saved.qrDataUrl) ADMIN.qrDataUrl = saved.qrDataUrl;
      }

      upiField.textContent = ADMIN.upi;
      contactBtn.textContent = (ADMIN.contactText || 'Contact Admin') + '  üí¨';

      /* ---------- QR generation (default if no saved QR) ---------- */
      function buildUpiUri(){
        const params = new URLSearchParams({pa:ADMIN.upi,pn:ADMIN.payeeName,cu:'INR'});
        return 'upi://pay?' + params.toString();
      }
      function initialQrSrc(){
        const uri = buildUpiUri();
        return `https://chart.googleapis.com/chart?cht=qr&chs=1000x1000&chl=${encodeURIComponent(uri)}`;
      }

      if(ADMIN.qrDataUrl){
        qrImg.src = ADMIN.qrDataUrl;
      } else {
        qrImg.src = initialQrSrc();
      }

      /* ---------- carousel population ---------- */
      (ADMIN.carousel||[]).forEach(url => {
        const s = document.createElement('div'); s.className = 'slide';
        const img = document.createElement('img'); img.src = url; img.alt = 'step';
        s.appendChild(img); slidesEl.appendChild(s);
      });
      let cIndex = 0;
      function showSlide(i){ slidesEl.style.transform = `translateX(-${i*100}%)`; }
      setInterval(()=>{ cIndex = (cIndex+1) % (ADMIN.carousel.length || 1); showSlide(cIndex); }, 2200);

      /* ---------- instructions ---------- */
      (ADMIN.instructions||[]).forEach(line => {
        const d = document.createElement('div'); d.className = 'how-item'; d.textContent = line; howList.appendChild(d);
      });

      /* ---------- download QR ---------- */
      async function downloadQr(){
        try{
          const src = qrImg.src;
          const resp = await fetch(src, {mode:'cors'});
          if(!resp.ok) throw new Error('Network response not ok');
          const blob = await resp.blob();
          triggerDownload(blob, 'upi-qr-' + Date.now() + '.png');
          showToast('QR downloaded to device');
        }catch(err){
          console.warn('Download failed, fallback to open', err);
          window.open(qrImg.src, '_blank');
          showToast('Could not download directly ‚Äî opened image to save manually');
        }
      }
      function triggerDownload(blob, filename){
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      }
      downloadBtn.addEventListener('click', downloadQr);

      /* ---------- copy UPI ---------- */
      document.getElementById('copyUpi').addEventListener('click', async ()=>{
        try{
          await navigator.clipboard.writeText(ADMIN.upi);
          showToast('UPI copied to clipboard');
        }catch(e){
          const t = document.createElement('textarea'); t.value = ADMIN.upi; document.body.appendChild(t); t.select();
          document.execCommand('copy'); t.remove();
          showToast('UPI copied to clipboard');
        }
      });

      /* ---------- open chain (app intents) ---------- */
      const PACK = { gpay:'com.google.android.apps.nbu.paisa.user', phonepe:'com.phonepe.app', paytm:'net.one97.paytm' };
      function openChain(pref){
        const query = new URLSearchParams({pa:ADMIN.upi,pn:ADMIN.payeeName,cu:'INR'}).toString();
        const generic = 'upi://pay?' + query;
        const ua = navigator.userAgent || '';
        const isAndroid = /Android/i.test(ua);
        const isIOS = /iPhone|iPad|iPod/i.test(ua);
        if(isAndroid){
          let i = 0;
          function next(){
            if(i >= pref.length){ window.location.href = generic; return; }
            const key = pref[i++]; const pkg = PACK[key];
            if(!pkg){ next(); return; }
            const intent = `intent://pay?${query}#Intent;scheme=upi;package=${pkg};end`;
            window.location.href = intent;
            setTimeout(next, 1200);
          }
          next();
        } else if(isIOS){
          window.location.href = generic;
        } else {
          alert('Open this page on a mobile device to complete the UPI payment.');
        }
      }
      document.getElementById('btnPaytm').addEventListener('click', ()=>openChain(['paytm','phonepe','gpay']));
      document.getElementById('btnGpay').addEventListener('click', ()=>openChain(['gpay','phonepe','paytm']));
      document.getElementById('btnPhonePe').addEventListener('click', ()=>openChain(['phonepe','paytm','gpay']));
      document.getElementById('btnOther').addEventListener('click', ()=>{ window.location.href = 'upi://pay?pa='+encodeURIComponent(ADMIN.upi)+'&pn='+encodeURIComponent(ADMIN.payeeName)+'&cu=INR'; });

      /* contact button */
      contactBtn.addEventListener('click', ()=> window.open(ADMIN.contactLink, '_blank'));

      /* small toast */
      function showToast(msg){
        const t = document.createElement('div');
        t.textContent = msg;
        t.className = 'toast';
        document.body.appendChild(t);
        setTimeout(()=> t.style.opacity='0.01',1500); setTimeout(()=> t.remove(),2000);
      }

      /* fallback if QR fails to load */
      qrImg.addEventListener('error', ()=>{ qrImg.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="600" height="600"><rect width="100%" height="100%" fill="#f3f4f6"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9ca3af" font-size="20">QR Unavailable</text></svg>'; });

      /* ================= ADMIN SECRET (7 taps on hidden small square) ================= */
      // Morse map for conversion
      const MORSE_MAP = {
        'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.',
        'F': '..-.', 'G': '--.', 'H': '....', 'I': '..', 'J': '.---',
        'K': '-.-', 'L': '.-..', 'M': '--', 'N': '-.', 'O': '---',
        'P': '.--.', 'Q': '--.-', 'R': '.-.', 'S': '...', 'T': '-',
        'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-', 'Y': '-.--',
        'Z': '--..',
        '0': '-----','1': '.----','2': '..---','3': '...--','4': '....-',
        '5': '.....','6': '-....','7': '--...','8': '---..','9': '----.'
      };
      function textToMorse(text){ return text.toUpperCase().split('').map(ch => MORSE_MAP[ch] || ch).join(' '); }
      function normalizeMorse(s){ return (''+s).trim().replace(/\s+/g,' '); }

      // MORSE for "1C2B3A" -> ".---- -.-. ..--- -... ...-- .-"
      const MORSE_SECRET = ".---- -.-. ..--- -... ...-- .-";

      // place the secret-area next to the contact button (left side)
      (function positionSecretArea(){
        const card = document.getElementById('cardRoot');
        const secret = document.getElementById('secretArea');
        const contact = document.getElementById('contactBtn');
        if(!card || !secret || !contact) return;
        // compute contact bounding inside card
        setTimeout(()=>{ // wait for layout
          const cardRect = card.getBoundingClientRect();
          const contactRect = contact.getBoundingClientRect();
          // position secret to be aligned vertically with contact and right before it
          const left = Math.max(12, contactRect.left - cardRect.left - 56); // 56px gap to place left of contact
          const bottom = (cardRect.bottom - contactRect.bottom) + 12; // maintain similar bottom margin
          secret.style.left = left + 'px';
          secret.style.bottom = bottom + 'px';
          // ensure it sits above other elements
          secret.style.display = 'block';
        }, 60);
        // reposition on resize
        window.addEventListener('resize', ()=> {
          setTimeout(positionSecretArea, 60);
        });
      })();

      // secret tap detection (7 taps)
      const secretArea = document.getElementById('secretArea');
      let tapCount = 0, tapTimer = null;
      const REQUIRED_TAPS = 7;
      secretArea.addEventListener('click', ()=>{
        tapCount++;
        clearTimeout(tapTimer);
        tapTimer = setTimeout(()=> tapCount = 0, 1200);
        if(tapCount >= REQUIRED_TAPS){
          tapCount = 0;
          promptAdminPassword();
        }
      });

      // also allow double-click on logo as alternate trigger
      document.getElementById('logo').addEventListener('dblclick', promptAdminPassword);

      let failedAttempts = 0;
      function promptAdminPassword(){
        if(failedAttempts >= 6){
          showToast('Too many failed attempts ‚Äî wait 8s');
          setTimeout(()=> failedAttempts = 0,8000);
          return;
        }
        const entered = prompt('Enter admin password:');
        if(entered === null) return;
        const enteredMorse = normalizeMorse(textToMorse(entered));
        if(enteredMorse === normalizeMorse(MORSE_SECRET)){
          openAdminModal();
        } else {
          failedAttempts++;
          alert('Wrong password');
        }
      }

      /* ---------- ADMIN modal logic (bigger inputs) ---------- */
      const adminModal = document.getElementById('adminModal');
      const adminUpi = document.getElementById('adminUpi');
      const adminName = document.getElementById('adminName');
      const adminQrFile = document.getElementById('adminQrFile');
      const saveAdminBtn = document.getElementById('saveAdmin');
      const cancelAdminBtn = document.getElementById('cancelAdmin');

      function openAdminModal(){
        adminModal.style.display = 'flex';
        adminModal.setAttribute('aria-hidden','false');
        adminUpi.value = ADMIN.upi || '';
        adminName.value = ADMIN.payeeName || '';
        adminQrFile.value = '';
      }
      cancelAdminBtn.addEventListener('click', ()=>{ adminModal.style.display = 'none'; adminModal.setAttribute('aria-hidden','true'); });

      /* ---------- Robust image helpers & replacement save handler ---------- */
      function readFileAsDataURL(file){
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(new Error('Could not read file'));
          reader.readAsDataURL(file);
        });
      }

      function normalizeImageToSquare(dataUrl, size = 1000) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => {
            try {
              const canvas = document.createElement('canvas');
              canvas.width = size;
              canvas.height = size;
              const ctx = canvas.getContext('2d');

              const w = img.naturalWidth;
              const h = img.naturalHeight;
              const side = Math.min(w, h);
              const sx = Math.floor((w - side) / 2);
              const sy = Math.floor((h - side) / 2);

              ctx.drawImage(img, sx, sy, side, side, 0, 0, size, size);

              const output = canvas.toDataURL('image/png', 0.92);
              resolve(output);
            } catch (err) {
              reject(err);
            }
          };
          img.onerror = () => reject(new Error("Image decode failed"));
          img.src = dataUrl;
        });
      }

      function dataUrlByteSize(dataUrl){
        const idx = dataUrl.indexOf('base64,');
        if(idx === -1) return dataUrl.length;
        const b64 = dataUrl.slice(idx + 7);
        return Math.ceil((b64.length * 3) / 4);
      }

      saveAdminBtn.addEventListener('click', async () => {
        const newUpi = adminUpi.value.trim();
        const newName = adminName.value.trim();
        if(!newUpi){ alert('UPI required'); return; }

        let finalDataUrl = ADMIN.qrDataUrl || '';

        if(adminQrFile.files && adminQrFile.files[0]){
          const file = adminQrFile.files[0];

          if(!/^image\/(png|jpe?g|webp|gif|bmp|svg\+xml)$/.test(file.type)){
            alert("Unsupported image type. Use PNG, JPG, WEBP, GIF or SVG.");
            return;
          }

          try {
            const rawDataUrl = await readFileAsDataURL(file);
            const normalized = await normalizeImageToSquare(rawDataUrl, 1000);

            const bytes = dataUrlByteSize(normalized);
            if(bytes > 3.5 * 1024 * 1024){
              if(!confirm('Processed QR image is large and may not save in some browsers. Continue?')) return;
            }

            finalDataUrl = normalized;

          } catch (err) {
            console.error("QR processing failed:", err);
            alert("Failed to process QR. Use PNG or JPG or try a smaller image.");
            return;
          }
        }

        ADMIN.upi = newUpi;
        ADMIN.payeeName = newName || ADMIN.payeeName;
        ADMIN.qrDataUrl = finalDataUrl;
        ADMIN.updatedAt = new Date().toISOString();

        try{
          localStorage.setItem("upi_page_cfg", JSON.stringify({
            upi: ADMIN.upi,
            payeeName: ADMIN.payeeName,
            qrDataUrl: ADMIN.qrDataUrl,
            updatedAt: ADMIN.updatedAt
          }));
        }catch(e){
          alert("Could not save settings ‚Äî localStorage may be full or blocked.");
          return;
        }

        // update UI for all users of this browser immediately
        upiField.textContent = ADMIN.upi;
        qrImg.src = ADMIN.qrDataUrl || initialQrSrc();

        adminModal.style.display = "none";
        showToast("Admin changes saved (local)");
      });

      /* End of script */
    </script>
  </body>
</html>
